# Database Query Scripts

A collection of SQL query scripts for analyzing and monitoring the YouTube semantic search engine database (`data/videos.db`). These scripts provide multiple statistical views for development and debugging.

## Quick Start

Run any query from the project root:

```bash
# Basic usage with column formatting
sqlite3 -header -column data/videos.db < scripts/queries/overview.sql

# Export to CSV
sqlite3 -header data/videos.db < scripts/queries/channels.sql > channels_report.csv

# View output with pagination
sqlite3 -header -column data/videos.db < scripts/queries/content_stats.sql | less

# Save to file with formatting
sqlite3 -header -column data/videos.db < scripts/queries/overview.sql > stats_report.txt
```

## Query Scripts

### Core Analysis Queries

#### 1. **overview.sql** - Database Overview
Quick snapshot of database status and key metrics.

**Output includes:**
- Total videos, channels, and indexing progress
- Data cleaning status (cleaned_title/description counts)
- Average engagement metrics (views, likes, comments, duration)
- Record counts for all tables

**Usage:**
```bash
sqlite3 -header -column data/videos.db < scripts/queries/overview.sql
```

---

#### 2. **channels.sql** - Channel Analysis
Video distribution and performance metrics by channel.

**Output includes:**
- Top channels by video count
- Channel distribution tiers (1 video, 2-5, 6-10, 10+)
- Most active channels (by recent uploads)
- Highest engagement channels (by like/comment rates)

**Usage:**
```bash
sqlite3 -header -column data/videos.db < scripts/queries/channels.sql | head -50
```

---

#### 3. **content_stats.sql** - Content Statistics
Video length distribution, popularity tiers, and engagement patterns.

**Output includes:**
- Video length distribution (<5min, 5-15min, etc.)
- Popularity tiers (<1K, 1K-10K, 10K-100K, >100K views)
- Overall engagement rates (likes and comments per view)
- Most/least viewed videos
- Publication date distribution (last 24 months)

**Usage:**
```bash
sqlite3 -header -column data/videos.db < scripts/queries/content_stats.sql
```

---

#### 4. **embedding_progress.sql** - Embedding Progress
Monitor embedding generation and API usage.

**Output includes:**
- Indexing status (indexed vs unindexed videos)
- Embeddings generated by type (title vs description)
- Token usage and API cost analysis
- Embedding timeline (date-by-date progress)
- Cost projection for remaining unindexed videos
- Recent embedding entries with video details

**OpenAI Pricing:**
- Model: `text-embedding-3-small`
- Cost: $0.00002 per 1K tokens

**Usage:**
```bash
sqlite3 -header -column data/videos.db < scripts/queries/embedding_progress.sql
```

---

#### 5. **evaluation_summary.sql** - Search Quality Metrics
Track manual evaluation results and search quality.

**Output includes:**
- Total evaluations and unique queries evaluated
- Average relevance score distribution (1-5 scale)
- Best result position distribution (top 1-5)
- Evaluation breakdown by query type
- Recent evaluations (last 20)
- Evaluation timeline with trending metrics
- Queries awaiting evaluation
- Notes from evaluators

**Usage:**
```bash
sqlite3 -header -column data/videos.db < scripts/queries/evaluation_summary.sql
```

---

#### 6. **data_quality.sql** - Data Quality Checks
Identify data integrity issues and completeness.

**Output includes:**
- Data completeness (NULL field counts and percentages)
- Potential duplicate detection (by title)
- Outliers: unusually long videos (>2 hours)
- Outliers: extreme view counts (>2 standard deviations)
- Unusually short videos (<1 minute)
- Data entry issues (zero views, missing fields)

**Usage:**
```bash
sqlite3 -header -column data/videos.db < scripts/queries/data_quality.sql
```

---

#### 7. **trending_analysis.sql** - Temporal Analysis
Publication trends and view patterns over time.

**Output includes:**
- Most recent videos (ordered by publish date)
- Recent videos from last 30, 90 days, and 1 year
- Publication trends by year and month
- Most viewed videos in last year
- Oldest videos in database (with age calculation)
- View growth patterns across decades

**Usage:**
```bash
sqlite3 -header -column data/videos.db < scripts/queries/trending_analysis.sql
```

---

#### 8. **search_testing.sql** - Test Query Suite Status
Monitor the status of test queries and evaluations.

**Output includes:**
- Test query suite statistics (count by type)
- Evaluation coverage (evaluated vs pending)
- Coverage breakdown by query type
- All test queries with evaluation status
- Unevaluated queries (ready for testing)
- Highest/lowest rated queries
- Expected channel analysis

**Usage:**
```bash
sqlite3 -header -column data/videos.db < scripts/queries/search_testing.sql
```

---

### Extended Analysis Queries

#### 9. **cost_analysis.sql** - API Cost Tracking
Detailed cost analysis and projections for embedding API usage.

**Output includes:**
- Embeddings generated summary (title vs description)
- Historical cost breakdown by embedding type
- Cost per video (average, min, max)
- Projection for remaining unindexed videos
- Projected total project cost (full indexing)
- Cost analysis by channel
- Daily and weekly cost trends
- Token distribution statistics

**OpenAI Pricing Formula:**
```
Cost = (total_tokens / 1000) Ã— $0.00002
```

**Usage:**
```bash
sqlite3 -header -column data/videos.db < scripts/queries/cost_analysis.sql

# Save cost report
sqlite3 -header -column data/videos.db < scripts/queries/cost_analysis.sql > cost_report.txt
```

---

#### 10. **comparison_queries.sql** - Before/After Comparisons
Compare search quality metrics across algorithm changes (A/B testing).

**Output includes:**
- Overall evaluation metrics (average relevance, top-1 accuracy)
- Relevance score distribution
- Metrics by time period (early vs late evaluations)
- Daily evaluation trends
- Performance breakdown by query type
- Queries showing improvement (ascending relevance)
- Queries showing regression (descending relevance)
- Template for comparing specific date cutoffs

**Use Cases:**
- Compare search quality before/after embedding weight adjustments
- Track impact of data cleaning on results
- Measure improvements from new embedding strategies
- A/B test different ranking algorithms

**Usage:**
```bash
sqlite3 -header -column data/videos.db < scripts/queries/comparison_queries.sql

# To compare two specific periods, edit the date cutoff:
# Change: WHERE DATE(created_at) < '2025-01-01'
# To your actual cutoff date
```

---

#### 11. **export_reports.sql** - CSV and Markdown Exports
Generate formatted reports for spreadsheets and documentation.

**Output includes:**
- Channel leaderboard (CSV format for Excel/Google Sheets)
- Content distribution report (CSV)
- Search quality scorecard (Markdown table)
- Top 20 videos by views (Markdown table)
- Data quality summary (Markdown table)
- Complete video catalog export (CSV with all metadata)
- Embedding cost report (CSV by date)
- Test query results matrix (Markdown)

**Usage:**
```bash
# Export channel leaderboard as CSV
sqlite3 data/videos.db < scripts/queries/export_reports.sql | head -100 > channels.csv

# View markdown report in terminal
sqlite3 data/videos.db < scripts/queries/export_reports.sql | grep -A 20 "SCORECARD"

# Save all reports to files
sqlite3 data/videos.db < scripts/queries/export_reports.sql > all_reports.txt
```

---

## Common Workflows

### Daily Progress Check
```bash
# Quick overview of indexing and data cleaning progress
sqlite3 -header -column data/videos.db < scripts/queries/overview.sql

# Check if any data quality issues
sqlite3 -header -column data/videos.db < scripts/queries/data_quality.sql | head -30
```

### Before Indexing Videos
```bash
# Check current embedding status and cost projections
sqlite3 -header -column data/videos.db < scripts/queries/embedding_progress.sql

# Review overall costs
sqlite3 -header -column data/videos.db < scripts/queries/cost_analysis.sql | grep -A 5 "PROJECTION"
```

### After Evaluation Session
```bash
# Review evaluation progress
sqlite3 -header -column data/videos.db < scripts/queries/evaluation_summary.sql

# Identify which queries need more evaluation
sqlite3 -header -column data/videos.db < scripts/queries/search_testing.sql | grep -A 20 "COVERAGE"
```

### Algorithm Tuning
```bash
# Check quality metrics before change
sqlite3 -header -column data/videos.db < scripts/queries/comparison_queries.sql | head -15

# After making changes, run again to compare
# Edit comparison_queries.sql to set the date cutoff at your change point
```

### Generate Reports for Documentation
```bash
# Export channel stats
sqlite3 -header -column data/videos.db < scripts/queries/channels.sql > reports/channels.txt

# Export quality metrics
sqlite3 -header -column data/videos.db < scripts/queries/export_reports.sql | grep -A 10 "SCORECARD" > reports/quality.md

# Full data export for analysis
sqlite3 -header data/videos.db < scripts/queries/export_reports.sql | head -1000 > reports/data_export.csv
```

---

## Database Schema Reference

### videos table
Main video metadata table (410 records).

```sql
CREATE TABLE videos (
    video_id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    cleaned_title TEXT,
    description TEXT,
    cleaned_description TEXT,
    channel_name TEXT,
    channel_id TEXT,
    published_at TIMESTAMP,
    duration_seconds INTEGER,
    view_count INTEGER,
    like_count INTEGER,
    comment_count INTEGER,
    is_indexed BOOLEAN DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

### embeddings_log table
Tracks embedding generation for cost and progress monitoring.

```sql
CREATE TABLE embeddings_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    video_id TEXT,
    embedding_type TEXT,  -- 'title' or 'description'
    model TEXT,           -- e.g. 'text-embedding-3-small'
    token_count INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (video_id) REFERENCES videos(video_id)
)
```

### evaluation_results table
Manual search quality ratings.

```sql
CREATE TABLE evaluation_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    query_text TEXT,
    relevance_score INTEGER,  -- 1-5
    best_result_position INTEGER,  -- 1-5 (position of best result)
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

### test_queries table
Test query suite for systematic evaluation.

```sql
CREATE TABLE test_queries (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    query_text TEXT NOT NULL,
    query_type TEXT,  -- e.g. 'topical', 'conceptual', 'technical'
    expected_channels TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

---

## Tips and Best Practices

### Performance
- For large result sets, pipe output through `less` or save to file
- Use `LIMIT` in queries to get first N results quickly
- Avoid running all scripts at once if database is large

### Output Formatting

```bash
# Column mode (default, readable)
sqlite3 -header -column data/videos.db < script.sql

# CSV mode (for Excel/spreadsheets)
sqlite3 -header data/videos.db < script.sql > export.csv

# Save with pagination
sqlite3 -header -column data/videos.db < script.sql | less

# Count lines in output
sqlite3 -header -column data/videos.db < script.sql | wc -l
```

### Editing Queries
Many scripts have customizable parameters:
- **comparison_queries.sql**: Edit the date cutoff for before/after analysis
- **embedding_progress.sql**: Adjust token average estimates
- **export_reports.sql**: Toggle between CSV and markdown modes

### Troubleshooting

```bash
# Verify database exists and is readable
ls -la data/videos.db
sqlite3 data/videos.db ".tables"

# Check table row counts
sqlite3 data/videos.db "SELECT name, COUNT(*) FROM sqlite_master WHERE type='table' GROUP BY name;"

# Quick test
sqlite3 data/videos.db "SELECT COUNT(*) FROM videos;"
```

---

## Adding New Queries

To create a new analysis query:

1. **Create a new `.sql` file** in `scripts/queries/`
2. **Add header comments** explaining purpose and usage
3. **Include formatting directives**:
   ```sql
   .headers on
   .mode column
   ```
4. **Add section headers** for readability:
   ```sql
   SELECT '=== SECTION NAME ===' as section;
   SELECT '';
   ```
5. **Test locally** before committing:
   ```bash
   sqlite3 -header -column data/videos.db < scripts/queries/new_query.sql
   ```
6. **Document in this README.md**

---

## See Also

- [CLAUDE.md](../../CLAUDE.md) - Project overview and architecture
- [main.py](../../main.py) - CLI commands and entry points
- OpenAI Embeddings API: https://platform.openai.com/docs/guides/embeddings
- SQLite documentation: https://www.sqlite.org/cli.html
